<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Loan Calculator</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        body {
            margin: 5px;
        }

        #idmaindiv {
            display: block;
            min-width: 40rem;
            width: 80%;
            margin: 0 auto;
            text-align: center;
        }

        input {
            font-family: sans-serif;
            font-size: 150%;
        }

        label {
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;
        }

        table {
            border: 1px solid black;
        }
        .cls40rw {
            width: 40rem;
        }

        td,
        thead {
            text-align: center;
        }

        thead,
        .clsnavline {
            border: 1px solid black;
            font-weight: bold;
        }


        .clsgreen {
            color: green;
        }

        .clsblue {
            color: blue;
        }

        .clsorange {
            color: orange;
        }

        .clsteal {
            color: teal;
        }

        .clsnavy {
            color: navy;
        }

        .clsred {
            color: red;
        }

        table {
            margin: 0 auto;
            width: 20rem;
        }

        #idcalc {
            font-family: sans-serif;
            font-size: 150%;
            width: 20rem;
            border-radius: 1rem;
            border: 2px solid blue;
        }

        tr.clsnavline td {
            text-decoration: underline;
            text-decoration-thickness: 0.2rem;
        }
        td p.clsfont120{
            font-size:120%;
        }
    </style>
</head>

<body>
    <div id="idmaindiv">
        <h1>
            <a name="atop"></a>
            Simple Loan Calculator
        </h1>
        <p>(Fixed Compound Interest + Monthly Payments)</p><br />
        <label for="idamount">Loan Amount:</label><br />
        <input type="text" id="idamount" /><br /><br />
        <label for="idapr">APR:</label><br />
        <input type="text" id="idapr" /><br /><br />
        <label for="idterm">Term:</label><br />
        <input type="text" id="idterm" /><br />
        <buttongroup id="idtermtype" name="natermtype">
            <label for="idtermmonths">Months</label>
            <input type="radio" id="idtermmonths" name="natermtype" value="m" />
            &nbsp;&nbsp;<label for="idtermyears">Years</label>
            <input type="radio" id="idtermyears" name="natermtype" value="y" checked />
        </buttongroup>
        <br /><br />
        <button type="button" id="idcalc" disabled>Calculate</button>
        <table>
            <thead>
                <tr>
                    <td style="width:33.3%" class="clsgreen">Amount:</td>
                    <td style="width:33.3%" class="clsblue">APR:</td>
                    <td style="width:33.3%" class="clsorange">Term:</td>
                </tr>
                <tr>
                    <td>
                        <p id="iddsplyamt">0</p>
                    </td>
                    <td>
                        <p id="iddsplyapr">0</p>
                    </td>
                    <td>
                        <p id="iddsplyterm">0</p>
                    </td>
                </tr>
                <tr>
                    <td colspan="3" class="clsteal">Monthly Payment:</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <p id="iddsplypmt" class="clsfont120">0.00</p>
                    </td>
                </tr>
                <tr>
                    <td colspan="3" class="clsnavy">Final Payment:</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <p id="iddsplyfnlpmt" class="clsfont120">0.00</p>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">Total of Payments:</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <p id="iddsplyttlpmt" class="clsfont120">0.00</p>
                    </td>
                </tr>
                <tr>
                    <td colspan="3" class="clsred">Total Interest:</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <p id="iddsplyttlint" class="clsfont120">0.00</p>
                    </td>
                </tr>
            </thead>
        </table>
        <br />

        <table class="cls40rw">
            <thead>
                <tr>
                    <td colspan="6">Amortization Schedule</td>
                </tr>
            </thead>
            <tbody id="idtblamortbody">
            </tbody>
        </table>
        <br />
    </div>
</body>
<script>
    /*
    * A Note on Rounding:
    *  In attempting to run down the exact rounding that is used for
    * total of payments and monthly interest calc(is it truncate or
    * round half-even, or whatever??), I've checked many loan
    * calculation websites that just DON'T agree with each other and
    * I haven't been able to find any authoritative documentation to
    * settle this question...so allow some slack with the exactness,
    * please.
    */

    function amortLine(i, begbal, pmt, prin, intrst, endbal) {
        return `<tr><td>${i}</td><td>${fmtFromCents(begbal)}</td>` +
            `<td>${fmtFromCents(pmt)}</td><td>${fmtFromCents(prin)}</td>` +
            `<td>${fmtFromCents(intrst)}</td><td>${fmtFromCents(endbal)}</td></tr>`;
    }
    function buttonManager() {
        idcalc.disabled = !(idamount.getAttribute("usenum").length &&
            idapr.getAttribute("usenum").length &&
            idterm.getAttribute("usenum").length);
    }
    function calcPmt(amt/*in cents*/, rpp, nper) {
        //returns the monthly payment and total payback in terms of whole cents!
        if (rpp < 1e-11)//zero interest ??
            return [Math.roundHalfEven(amt / nper), amt];
        const pmt = (amt * rpp) / (1.0 - Math.pow((1.0 + rpp), -nper));
        const payback = pmt * nper;
        // console.log(payback);
        return [Math.roundHalfEven(pmt), Math.floor(payback)];
    }
    function fmtFromCents(x) {
        return Math.floor(x / 100).toLocaleString() + "." + String(x % 100).padStart(2, '0');
    }
    function hdrLine(addanchor = true) {
        return (addanchor ? '<tr><td colspan="6"><a href="#atop">Back To Top</a></td></tr>' : '') +
            '<tr class="clsnavline"><td>&numero;</td><td class="clsgreen">Beg Bal</td>' +
            '<td class="clsteal">Payment</td><td>Principle</td><td class="clsred">Interest</td>' +
            '<td class="clsgreen">End Bal </td></tr>';
    }
    function inpChanged(e) {
        const rxamount = new RegExp(/^\s*\$?(\d+|\d{1,3}(,\d{3})*)\s*$/);
        const rxapr = new RegExp(/^\s*(\d+(\.\d*)?|\.\d+)%?\s*$/);
        const rxterm = new RegExp(/^\s*\d+\s*$/);
        let el = e.srcElement;
        if (el.id.startsWith("idterm"))
            el = idterm;
        let mat, n, valid = false;
        switch (el.id) {
            case "idamount":
                mat = idamount.value.match(rxamount);
                if (!mat) break;
                n = Number(mat[0].replace(/[$,]/g, ''));
                valid = n >= 100 && n < 1e9;
                break;
            case "idapr":
                mat = idapr.value.match(rxapr);
                if (!mat) break;
                n = Number(mat[0].replace(/%$/, ''));
                valid = n >= 0 && n < 1000;
                break;
            case "idterm":
                mat = idterm.value.match(rxterm);
                if (!mat) break;
                const tvalue = idtermmonths.checked ? [6, 720] : [1, 60];
                n = mat[0] - 0;
                valid = n >= tvalue[0] && n <= tvalue[1];
                break;
            default:
        }

        el.style.color = valid ? "black" : "red";
        el.setAttribute("usenum", valid ? n.toString() : "");
        buttonManager();
    }
    function showResults(e) {
        idcalc.innerHTML = 'Building Table...';
        idcalc.disabled = true;
        setTimeout(_showResults, 10);
    }
    function _showResults() {
        const amt = (idamount.getAttribute("usenum") - 0) * 100/*cents per*/;
        const ratea = Number((idapr.getAttribute("usenum") - 0).toPrecision(4));
        const rateb = ratea / 1200;
        const terma = idterm.getAttribute("usenum") - 0;
        const termb = terma * (idtermmonths.checked ? 1 : 12);
        const [pmt, ttlpay] = calcPmt(amt, rateb, termb);

        //Summary
        iddsplyamt.innerHTML = fmtFromCents(amt);
        iddsplyapr.innerHTML = ratea + "%";
        iddsplyterm.innerHTML = terma + " " + (idtermmonths.checked ? "Mon." : "Yr.");
        iddsplypmt.innerHTML = fmtFromCents(pmt);
        const fnlpmt = ttlpay - (termb - 1) * pmt;
        iddsplyfnlpmt.innerHTML = fmtFromCents(fnlpmt);
        iddsplyttlpmt.innerHTML = fmtFromCents(ttlpay);
        const ttlint = ttlpay - amt;
        iddsplyttlint.innerHTML = fmtFromCents(ttlint);

        //Amort
        idtblamortbody.innerHTML = '';
        let innertext = '';
        innertext += hdrLine(false);
        let begbal = amt, endbal, prin, intrst, remint = ttlint;
        for (let i = 1; i <= termb - 1; ++i) {
            intrst = Math.min(remint, Math.roundHalfEven(begbal * rateb));
            innertext += amortLine(i, begbal, pmt, pmt - intrst, intrst, begbal - (pmt - intrst));
            begbal -= pmt - intrst;
            remint -= intrst;
            if (i > 1 && i % 12 == 1)
                innertext += hdrLine();
        }
        innertext += amortLine(termb, begbal, fnlpmt, fnlpmt - remint, remint, 0);
        idtblamortbody.innerHTML = innertext;

        idcalc.innerHTML = 'Calculate';
        idcalc.disabled = false;
    }
    {
        idamount.value = idapr.value = idterm.value = '';
        idamount.addEventListener("input", inpChanged);
        idapr.addEventListener("input", inpChanged);
        idterm.addEventListener("input", inpChanged);
        idtermtype.addEventListener("input", inpChanged);
        idcalc.addEventListener("click", showResults);
        idamount.setAttribute("usenum", "");
        idapr.setAttribute("usenum", "");
        idterm.setAttribute("usenum", "");
        Math.roundHalfEven = (x) => {
            if (!isFinite(x) || Math.abs(x - Math.floor(x)) != 0.5)
                return Math.round(x);
            return Math.floor(x) % 2 ? Math.ceil(x) : Math.floor(x);
        }
        idamount.focus();
    }

</script>

</html>