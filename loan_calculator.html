<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Loan Calculator</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        body {
            margin: 5px;
        }

        #idmaindiv {
            display: block;
            min-width: 60rem;
            margin: 0 auto;
            text-align: center;
        }

        input {
            font-family: sans-serif;
            font-size: 150%;
        }

        label {
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;
        }

        td,
        thead {
            text-align: center;
        }

        thead {
            font-weight: bold;
        }

        .clsnavline {
            border: 1px solid black;
            font-weight: bold;
        }


        .clsgreen {
            color: green;
        }

        .clsblue {
            color: blue;
        }

        .clsorange {
            color: orange;
        }

        .clsteal {
            color: teal;
        }

        .clsnavy {
            color: navy;
        }

        .clsred {
            color: red;
        }

        table {
            border-collapse: collapse;
            margin: 0 auto;
        }

        div.clsscroll {
            display: inline-flex;
            min-width: 50.5rem;
            max-height: 20rem;
            text-align: center;
            overflow-y: scroll;
        }
        div.clsnarrow {
            min-width: 36.5rem;
        }
        #idtblamorthead {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: white;
        }

        #idcalc {
            font-family: sans-serif;
            font-size: 150%;
            width: 20rem;
            border-radius: 1rem;
            border: 2px solid blue;
        }

        tr.clsnavline td {
            text-decoration: underline;
            text-decoration-thickness: 0.2rem;
        }

        td p.clsfont100 {
            font-size: 100%;
        }

        td.clslrgr {
            font-size: 125%;
        }

        #iddivamorthdr div {
            text-decoration: underline;
        }

        #idmonth,
        #idyear {
            width: 6rem;
        }

        #idamount,
        #idapr,
        #idterm {
            width: 8rem;
        }

        input {
            text-align: right;
        }

        #idtblsum {
            min-width: 25rem;
        }

        #idtblsum td.clssum {
            text-align: right;
        }

        #idtblsum {
            border: 2px solid blue;
        }

        #idtblamort {
            /* border-left: 2px solid blue; */
            /* border-right: 2px solid blue; */
            min-width: 50rem;
            border-bottom: 2px solid blue;
        }
        #idtblamort.clsnarrow {
            min-width: 36rem;
        }
        #idtblamort thead button {
            font-size: 70%;
        }

        #iddivamorthdr {
            border-bottom: 2px solid blue;
            /* margin-right: 10px; */
        }

        #idamortdetails div,
        #iddivamorthdr div {
            padding-right: 10px;
        }
    </style>
</head>

<body>
    <div id="idmaindiv">
        <h1>
            <a name="atop"></a>
            Simple Loan Calculator
        </h1>
        <p>(Fixed Compound Interest + Monthly Payments)</p><br />
        <label for="idstart">Starting Month &amp; Year:</label><br />
        <input type="number" id="idmonth" min="1" max="12" />
        <input type="number" id="idyear" min="2026" /><br />
        <div style="display:flex;align-items:center;justify-content:center">
            <div style="margin-right:5px">
                <label for="idamount">Loan Amount:</label><br />
                <input type="text" id="idamount" />
            </div>
            <div>
                <label for="idapr">APR%:</label><br />
                <input type="text" id="idapr" />
            </div>
        </div>
        <label for="idterm">Term:</label><br />
        <input type="text" id="idterm" /><br />
        <fieldset id="idtermtype" name="natermtype" style="border:none">
            <label for="idtermmonths">Months</label>
            <input type="radio" id="idtermmonths" name="natermtype" value="m" />
            &nbsp;&nbsp;<label for="idtermyears">Years</label>
            <input type="radio" id="idtermyears" name="natermtype" value="y" checked />
        </fieldset>
        <br /><br />
        <button type="button" id="idcalc" disabled>Calculate</button>
        <table id="idtblsum">
            <thead>
                <tr>
                    <td style="width:33.3%">Amount:</td>
                    <td style="width:33.3%">APR:</td>
                    <td style="width:33.3%">Term:</td>
                </tr>
                <tr>
                    <td>
                        <p id="iddsplyamt">0</p>
                    </td>
                    <td>
                        <p id="iddsplyapr">0</p>
                    </td>
                    <td>
                        <p id="iddsplyterm">0</p>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" class="clssum">Monthly Payment:</td>
                    <td class="clssum">
                        <p id="iddsplypmt" class="clsfont100">0.00</p>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" class="clssum">Final Payment:</td>
                    <td class="clssum">
                        <p id="iddsplyfnlpmt" class="clsfont100">0.00</p>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" class="clssum">Total of Payments:</td>
                    <td class="clssum">
                        <p id="iddsplyttlpmt" class="clsfont100">0.00</p>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" class="clssum">Total Interest:</td>
                    <td class="clssum">
                        <p id="iddsplyttlint" class="clsfont100">0.00</p>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" class="clssum">Last Payment Date:</td>
                    <td class="clssum">
                        <p id="iddsplylastpay" class="clsfont100"></p>
                    </td>
                </tr>
            </thead>
        </table>
        <br />
        <div class="clsscroll">
            <table id="idtblamort">
                <thead id="idtblamorthead">
                </thead>
                <tbody id="idtblamortbody">
                </tbody>
            </table>
        </div>
    </div>
    <br /><br />
</body>
<script>
    /*
    * A Note on Rounding:
    *  In attempting to run down the exact rounding that is used for
    * total of payments and monthly interest calc(is it truncate or
    * round half-even, or whatever??), I've checked many loan
    * calculation websites that just DON'T agree with each other and
    * I haven't been able to find any authoritative documentation to
    * settle this question...so allow some slack with the exactness,
    * please.
    */
    function details(){
        const mon = idmonth.value-0, yr = idyear.value-0;
        const amt = (idamount.getAttribute("usenum") - 0) * 100/*cents per*/;
        const ratea = Number((idapr.getAttribute("usenum") - 0).toPrecision(4));
        const rateb = ratea / 1200;
        const terma = idterm.getAttribute("usenum") - 0;
        const termb = terma * (idtermmonths.checked ? 1 : 12);
        const [pmt, ttlpay] = calcPmt(amt, rateb, termb);
        const ttlint = ttlpay - amt;
        const fnlpmt = ttlpay - (termb - 1) * pmt;
        return {"mon":mon, "yr":yr, "amt":amt, "ratea":ratea, "rateb":rateb, "terma":terma, "termb":termb,
                "pmt":pmt, "ttlpay":ttlpay, "ttlint":ttlint, "fnlpmt":fnlpmt};
    }
    function amortByMonth() {
        const HDR =
            `
        <tr>
            <td colspan="7" class="clslrgr">Monthly Amortization Schedule&nbsp;&nbsp;
            <button id="idamorttype" type="button" onclick="amortByYear()">Yearly Summary</button></td>
        </tr>
        <tr>
            <td>&numero;</td>
            <td>MM/YY</td>
            <td>Beg Bal</td>
            <td>Payment</td>
            <td>Principle</td>
            <td class="clsred">Interest</td>
            <td>End Bal</td>
        </tr>
        `.trim();
        function amortLine(i, mmyy, begbal, pmt, prin, intrst, endbal) {
            return `<tr>
                        <td>${i}</td>
                        <td>${mmyy}</td>
                        <td>${fmtFromCents(begbal)}</td>
                        <td>${fmtFromCents(pmt)}</td>
                        <td>${fmtFromCents(prin)}</td>
                        <td>${fmtFromCents(intrst)}</td>
                        <td>${fmtFromCents(endbal)}&nbsp;</td>
                    </tr>`;
        };
        const dtl = details();
        let mon = dtl.mon, yr = dtl.yr;
        let innertext = '';
        let begbal = dtl.amt, endbal, prin, intrst, remint = dtl.ttlint;
        for (let i = 1; i <= dtl.termb - 1; ++i) {
            intrst = Math.min(remint, Math.roundHalfEven(begbal * dtl.rateb));
            innertext += amortLine(i, `${String(mon).padStart(2,'0')}/${yr%100}`, begbal, dtl.pmt, dtl.pmt - intrst, intrst, begbal - (dtl.pmt - intrst));
            [mon, yr] = monthsDiff(mon, yr, 1);
            begbal -= dtl.pmt - intrst;
            remint -= intrst;
        }
        innertext += amortLine(dtl.termb, `${String(mon).padStart(2,'0')}/${yr%100}`, begbal, dtl.fnlpmt, dtl.fnlpmt - remint, remint, 0);
        idtblamorthead.innerHTML = HDR;
        idtblamortbody.innerHTML = innertext;
        idtblamort.className = idtblamort.className.replace(" clsnarrow","");
        idtblamort.parentElement.className = idtblamort.parentElement.className.replace(" clsnarrow","");
    }
    function amortByYear() {
        const HDR =
            `
        <tr>
            <td colspan="5" class="clslrgr">Yearly Summary&nbsp;&nbsp;
            <button id="idamorttype" type="button" onclick="amortByMonth()">Monthly Schedule</button></td>
        </tr>
        <tr>
            <td>&numero;</td>
            <td>Year</td>
            <td>Principle</td>
            <td class="clsred">Interest</td>
            <td>Ending Bal</td>
        </tr>
        `.trim();
        function amortLine(i, yr, prin, intrst, endbal) {
            return `<tr>
                        <td>${i}</td>
                        <td>${yr}</td>
                        <td>${fmtFromCents(prin)}</td>
                        <td>${fmtFromCents(intrst)}</td>
                        <td>${fmtFromCents(endbal)}&nbsp;</td>
                    </tr>`;
        };
        const dtl = details();
        let mon = dtl.mon, yr = dtl.yr;
        const startyr = yr;
        let intperyear = prinperyear = endyearbal = 0;
        let innertext = '';
        let begbal = dtl.amt, endbal, prin, intrst, remint = dtl.ttlint;
        for (let i = 1; i <= dtl.termb - 1; ++i) {
            intrst = Math.min(remint, Math.roundHalfEven(begbal * dtl.rateb));
            intperyear += intrst;
            prinperyear += dtl.pmt - intrst;
            begbal -= dtl.pmt - intrst;
            remint -= intrst;
            let [newmon, newyr] = monthsDiff(mon, yr, 1);
            if (newmon == 1) {
                endyearbal = begbal;
                innertext += amortLine(yr-startyr+1, String(yr), prinperyear,
                    intperyear, endyearbal);
                intperyear = prinperyear = endyearbal = 0;
            }
            mon = newmon, yr = newyr;
        }
        intperyear += remint;
        prinperyear += dtl.fnlpmt - remint;
        innertext += amortLine(yr-startyr+1, String(yr), prinperyear,
                    intperyear, endyearbal);
        idtblamorthead.innerHTML = HDR;
        idtblamortbody.innerHTML = innertext;
        idtblamort.className += " clsnarrow";
        idtblamort.parentElement.className += " clsnarrow";
    }
    function buttonManager() {
        idcalc.disabled = !(idamount.getAttribute("usenum").length &&
            idapr.getAttribute("usenum").length &&
            idterm.getAttribute("usenum").length);
    }
    function calcPmt(amt/*in cents*/, rpp, nper) {
        //returns the monthly payment and total payback in terms of whole cents!
        if (rpp < 1e-11)//zero interest ??
            return [Math.roundHalfEven(amt / nper), amt];
        const pmt = (amt * rpp) / (1.0 - Math.pow((1.0 + rpp), -nper));
        const payback = pmt * nper;
        // console.log(payback);
        return [Math.roundHalfEven(pmt), Math.floor(payback)];
    }
    function decimalSep() {
        return nstr = (0.1).toLocaleString().slice(-2, -1);
    }
    function fillSummary(amt, ratea, terma, termb, pmt, ttlpay, lastpay) {
        iddsplyamt.innerHTML = fmtFromCents(amt);
        iddsplyapr.innerHTML = ratea + "%";
        iddsplyterm.innerHTML = terma + " " + (idtermmonths.checked ? "Mon." : "Yr.");
        iddsplypmt.innerHTML = fmtFromCents(pmt);
        const fnlpmt = ttlpay - (termb - 1) * pmt;
        iddsplyfnlpmt.innerHTML = fmtFromCents(fnlpmt);
        iddsplyttlpmt.innerHTML = fmtFromCents(ttlpay);
        const ttlint = ttlpay - amt;
        iddsplyttlint.innerHTML = fmtFromCents(ttlint);
        iddsplylastpay.innerHTML = lastpay;
    }
    function fmtFromCents(x) {
        return Math.floor(x / 100).toLocaleString() + decimalSep() + String(x % 100).padStart(2, '0');
    }
    function inpChanged(e) {
        const rxamount = new RegExp(/^\s*(\d+|\d{1,3}([,\.]\d{3})*)\s*$/);
        const rxapr = new RegExp(/^\s*(\d+([\.,]\d*)?|[\.,]\d+)%?\s*$/);
        const rxterm = new RegExp(/^\s*\d+\s*$/);
        let el = e.srcElement;
        if (el.id.startsWith("idterm"))
            el = idterm;
        let mat, n, valid = false;
        switch (el.id) {
            case "idamount":
                mat = idamount.value.match(rxamount);
                if (!mat) break;
                n = Number(mat[0].replace(/[,\.]/g, ''));
                valid = n >= 100 && n < 1e11 && Number.isInteger(n);
                break;
            case "idapr":
                mat = idapr.value.match(rxapr);
                if (!mat) break;
                n = Number(mat[0].replace(/%$/, ''));
                valid = n >= 0 && n < 1000;
                break;
            case "idterm":
                mat = idterm.value.match(rxterm);
                if (!mat) break;
                const tvalue = idtermmonths.checked ? [6, 720] : [1, 60];
                n = mat[0] - 0;
                valid = n >= tvalue[0] && n <= tvalue[1];
                break;
            default:
        }

        el.style.color = valid ? "black" : "red";
        el.setAttribute("usenum", valid ? n.toString() : "");
        buttonManager();
    }
    function leaveMonth(evt) {
        if (!/^\d{1,2}$/.test(idmonth.value))
            idmonth.value = nextMonthYear()[0] + 1;
    }
    function leaveYear(evt) {
        if (!/^20\d\d$/.test(idyear.value))
            idyear.value = nextMonthYear()[1];
    }
    function monthsDiff(mo, yr, delta) {
        //returns an array with [month, year]
        //expects input and output month to be 1-based
        const date = new Date(yr, mo - 1, 1);
        date.setMonth(date.getMonth() + delta);
        return [date.getMonth() + 1, date.getFullYear()];

    }
    function nextMonthYear() {
        const now = new Date();
        const nextmonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        return [nextmonth.getMonth(), nextmonth.getFullYear()];
    }
    function showResults(e) {
        idcalc.innerHTML = 'Building Table...';
        idcalc.disabled = true;
        setTimeout(_showResults, 10);
    }
    function _showResults() {

        const dtl = details();

        let [mon, yr] = [idmonth.value, idyear.value];
        let [lastmon, lastyr] = monthsDiff(mon - 1 - 1, yr, dtl.termb);
        const lastpay = `${String(lastmon + 1).padStart(2, '0')}/${lastyr}`;

        fillSummary(dtl.amt, dtl.ratea, dtl.terma, dtl.termb, dtl.pmt, dtl.ttlpay, lastpay);

        amortByMonth();

        idcalc.innerHTML = 'Calculate';
        idcalc.disabled = false;
    }
    {
        idmonth.addEventListener("blur", leaveMonth)
        idyear.addEventListener("blur", leaveYear)

        idamount.value = idapr.value = idterm.value = '';
        idamount.addEventListener("input", inpChanged);
        idapr.addEventListener("input", inpChanged);
        idterm.addEventListener("input", inpChanged);
        idtermtype.addEventListener("input", inpChanged);
        idcalc.addEventListener("click", showResults);

        idamount.setAttribute("usenum", "");
        idapr.setAttribute("usenum", "");
        idterm.setAttribute("usenum", "");
        Math.roundHalfEven = (x) => {
            if (!isFinite(x) || Math.abs(x - Math.floor(x)) != 0.5)
                return Math.round(x);
            return Math.floor(x) % 2 ? Math.ceil(x) : Math.floor(x);
        }
        const nxt = nextMonthYear();
        idmonth.value = nxt[0] + 1;/*to one-based*/
        idyear.value = nxt[1];
        idmonth.focus();
    }

</script>

</html>
